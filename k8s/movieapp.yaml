# ========================
# Namespace
# ========================
apiVersion: v1
kind: Namespace
metadata:
  name: movie
---
# ========================
# StorageClass (Immediate Binding)
# ========================
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: gp2-immediate
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp2
volumeBindingMode: Immediate
reclaimPolicy: Delete
---
# ========================
# MySQL Database (movie-db)
# ========================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: movie-db-pvc
  namespace: movie
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: gp2-immediate
  resources:
    requests:
      storage: 1Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: movie-db
  namespace: movie
spec:
  replicas: 1
  selector:
    matchLabels:
      app: movie-db
  template:
    metadata:
      labels:
        app: movie-db
    spec:
      initContainers:
        - name: copy-sql-files
          image: busybox:1.36
          command: ['sh', '-c', 'cp /sql-files/*.sql /shared-init/ && ls -la /shared-init/']
          volumeMounts:
            - name: sql-files
              mountPath: /sql-files
              readOnly: true
            - name: init-db
              mountPath: /shared-init
      containers:
        - name: movie-db
          image: mysql:8.0
          env:
            - name: MYSQL_DATABASE
              value: movie_db
            - name: MYSQL_USER
              value: movieuser
            - name: MYSQL_PASSWORD
              value: moviepass
            - name: MYSQL_ROOT_PASSWORD
              value: rootpass
          ports:
            - containerPort: 3306
          volumeMounts:
            - name: movie-db-data
              mountPath: /var/lib/mysql
            - name: init-db
              mountPath: /docker-entrypoint-initdb.d/
          livenessProbe:
            exec:
              command: ["mysqladmin", "ping", "-h", "localhost"]
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            exec:
              command: ["mysqladmin", "ping", "-h", "localhost"]
            initialDelaySeconds: 20
            periodSeconds: 10
      volumes:
        - name: movie-db-data
          persistentVolumeClaim:
            claimName: movie-db-pvc
        - name: init-db
          emptyDir: {}
        - name: sql-files
          hostPath:
            # Update this path to match your actual SQL files location
            # For Windows: Use forward slashes or the Windows path format
            # Example: path: "D:/BookMyseat-application-shweta/movie-bookmyseat-nov25/src/main/resources/db/migration"
            # For Linux: path: "/path/to/movie-bookmyseat-nov25/src/main/resources/db/migration"
            path: /actual/path/to/movie-bookmyseat-nov25/src/main/resources/db/migration
            type: Directory
---
apiVersion: v1
kind: Service
metadata:
  name: movie-db
  namespace: movie
spec:
  selector:
    app: movie-db
  ports:
    - port: 3306
      targetPort: 3306
      protocol: TCP
---
# ========================
# Movie Service (Spring Boot backend)
# ========================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: movie-service
  namespace: movie
spec:
  replicas: 1
  selector:
    matchLabels:
      app: movie-service
  template:
    metadata:
      labels:
        app: movie-service
    spec:
      initContainers:
        - name: wait-for-mysql
          image: mysql:8.0
          command:
            ["sh", "-c", "until mysql -h movie-db -u movieuser -pmoviepass -e 'SELECT 1' >/dev/null 2>&1; do echo waiting for movie-db; sleep 5; done"]
      containers:
        - name: movie-service
          image: 543816070942.dkr.ecr.us-east-1.amazonaws.com/movieapp-backend:29
          ports:
            - containerPort: 8081
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: docker
            - name: SPRING_DATASOURCE_URL
              value: jdbc:mysql://movie-db:3306/movie_db
            - name: SPRING_DATASOURCE_USERNAME
              value: movieuser
            - name: SPRING_DATASOURCE_PASSWORD
              value: moviepass
            - name: ZIPKIN_ENDPOINT
              value: http://zipkin:9411/api/v2/spans
---
apiVersion: v1
kind: Service
metadata:
  name: movie-service
  namespace: movie
spec:
  selector:
    app: movie-service
  ports:
    - port: 8081
      targetPort: 8081
  type: ClusterIP
